name: CI — Build & Test

# Déclencheurs — quand s'exécute ce workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:

  # ============================================
  # Job 1 — Build Backend .NET
  # ============================================
  build-backend:
    name: Build Backend .NET
    runs-on: ubuntu-latest

    steps:
      # 1. Récupère le code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Installe .NET 10
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 3. Restaure les packages NuGet
      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./TaskFlow.API

      # 4. Compile le code
      - name: Build
        run: dotnet build --no-restore -c Release
        working-directory: ./TaskFlow.API

      # 5. Lance les tests (si tu en as)
      - name: Test
        run: dotnet test --no-build -c Release
        working-directory: ./TaskFlow.API

  # ============================================
  # Job 2 — Build Frontend React
  # ============================================
  build-frontend:
    name: Build Frontend React
    runs-on: ubuntu-latest

    steps:
      # 1. Récupère le code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Installe Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./taskflow-client/package-lock.json

      # 3. Installe les dépendances npm
      - name: Install dependencies
        run: npm install
        working-directory: ./taskflow-client

      # 4. Vérifie le code avec ESLint
      - name: Lint
        run: npm run lint
        working-directory: ./taskflow-client

      # 5. Compile React
      - name: Build
        run: npm run build
        working-directory: ./taskflow-client

  # ============================================
  # Job 3 — Build Docker Images
  # ============================================
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend] # attend que les 2 jobs précédents réussissent

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build image backend
      - name: Build Backend Docker image
        run: docker build -t taskflow-api ./TaskFlow.API

      # Build image frontend
      - name: Build Frontend Docker image
        run: docker build -t taskflow-frontend ./taskflow-client